# 要件定義書

## はじめに

神戸運転代行ヒロクルのウェブサイトにおいて、訪問者の位置情報を収集・分析し、管理者ダッシュボードで可視化する機能を実装します。この機能により、サービスエリア内外からのアクセス状況を把握し、マーケティング戦略の立案に活用します。

## 用語集

- **System（システム）**: 神戸運転代行ヒロクルのウェブアプリケーション
- **User（ユーザー）**: ウェブサイトの訪問者
- **Admin（管理者）**: 管理者（会社のスタッフ）
- **Location Data（位置情報データ）**: 緯度・経度の位置情報データ
- **Analytics Dashboard（分析ダッシュボード）**: 管理者用の分析ダッシュボード
- **Geolocation API（位置情報API）**: ブラウザの位置情報取得API
- **Service Area（サービスエリア）**: サービス提供エリア（神戸市全域、芦屋、西宮、尼崎）

## 要件

### 要件1：位置情報の自動取得

**ユーザーストーリー:** ユーザーとして、ウェブサイトを訪問した際に自動的に位置情報が検出されることで、ビジネスに位置ベースのインサイトを提供したい。

#### 受入基準

1. WHEN ユーザーがウェブサイトを訪問した時、THE System SHALL Geolocation APIを使用してユーザーのブラウザに位置情報の許可をリクエストする
2. IF ユーザーが位置情報の許可を付与した場合、THEN THE System SHALL 緯度と経度の座標を取得する
3. WHEN 位置情報データが取得された時、THE System SHALL ページをリロードせずにAJAX POSTリクエストでサーバーにデータを送信する
4. IF ユーザーが位置情報の許可を拒否した場合、THEN THE System SHALL 拒否をログに記録し、エラーなく通常のウェブサイト操作を継続する
5. THE System SHALL すべての位置情報データPOSTリクエストにCSRFトークンを含める

### 要件2：位置情報データの保存

**ユーザーストーリー:** 管理者として、位置情報データがデータベースに保存されることで、時系列で訪問者のパターンを分析したい。

#### 受入基準

1. WHEN システムがユーザーから位置情報データを受信した時、THE System SHALL 緯度、経度、タイムスタンプをデータベースに保存する
2. THE System SHALL 各位置情報レコードとともにユーザーのIPアドレスを保存する
3. THE System SHALL 各位置情報レコードとともにユーザーのユーザーエージェント文字列を保存する
4. THE System SHALL 利用可能な場合、参照元URLを各位置情報レコードとともに保存する
5. THE System SHALL 位置情報データが正常に保存された時、HTTP 201ステータスコードで応答する

### 要件3：位置情報分析の表示

**ユーザーストーリー:** 管理者として、ダッシュボードで位置情報分析を表示することで、ウェブサイト訪問者がどこから来ているかを理解したい。

#### 受入基準

1. WHEN 管理者がダッシュボードにアクセスした時、THE System SHALL 収集された位置情報レコードの総数を表示する
2. THE System SHALL 地理的エリア別の訪問者の内訳を表示する（サービスエリア内 vs サービスエリア外）
3. THE System SHALL サービスエリア内からの訪問者の割合を表示する
4. THE System SHALL タイムスタンプと概算住所を含む最近の位置情報レコードのリストを表示する
5. THE System SHALL 地図上に位置情報データを可視化して表示する

### 要件4：時系列分析

**ユーザーストーリー:** 管理者として、時系列ベースの分析を表示することで、ピークアクセス時間とトレンドを特定したい。

#### 受入基準

1. THE System SHALL 日付別にグループ化された位置情報データを表示する（今日、今週、今月）
2. THE System SHALL 時系列での訪問者数を示すチャートを表示する
3. THE System SHALL 日付範囲で位置情報データをフィルタリングできるようにする
4. THE System SHALL 最も一般的なアクセス時間を表示する（時間別の内訳）

### 要件5：プライバシー保護

**ユーザーストーリー:** ユーザーとして、プライバシーが保護されることで、個人情報が責任を持って取り扱われることを望む。

#### 受入基準

1. THE System SHALL IPアドレスと位置座標以外の個人を特定できる情報を保存しない
2. THE System SHALL 位置情報の許可をリクエストする前にプライバシー通知を表示する
3. THE System SHALL 位置情報の許可が拒否された場合でも、ウェブサイトが正常に機能することを許可する
4. THE System SHALL 30日後にIPアドレスを匿名化する
5. THE System SHALL 位置情報データ収集に関するプライバシー規制に準拠する

### 要件6：データエクスポート

**ユーザーストーリー:** 管理者として、位置情報分析データをエクスポートすることで、追加の分析やレポート作成を行いたい。

#### 受入基準

1. THE System SHALL 分析ダッシュボードにCSVエクスポートボタンを提供する
2. WHEN 管理者がエクスポートボタンをクリックした時、THE System SHALL すべての位置情報レコードを含むCSVファイルを生成する
3. THE System SHALL CSVエクスポートに緯度、経度、タイムスタンプ、IPアドレス、ユーザーエージェントを含める
4. THE System SHALL エクスポート前に日付範囲でデータをフィルタリングできるようにする
5. THE System SHALL エクスポートをファイルあたり最大10,000レコードに制限する

### 要件7：パフォーマンス

**ユーザーストーリー:** 開発者として、位置情報トラッキングがパフォーマンスに優れていることで、ウェブサイトの読み込み速度に悪影響を与えないようにしたい。

#### 受入基準

1. THE System SHALL ページ読み込み後に非同期で位置情報データをリクエストする
2. THE System SHALL 位置情報の許可を待っている間、ページのレンダリングをブロックしない
3. THE System SHALL 10秒後に位置情報リクエストをタイムアウトする
4. THE System SHALL 繰り返しリクエストを避けるため、ブラウザセッションに位置情報データをキャッシュする
5. THE System SHALL クエリパフォーマンスのため、タイムスタンプと座標カラムにデータベースインデックスを使用する
