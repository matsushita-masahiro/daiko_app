# お問い合わせ確認画面機能 - 設計書

## 概要

お問い合わせフォームに確認画面を追加し、2段階での送信プロセスを実装します。

## アーキテクチャ

### フロー設計

```
[new.html.erb] → [confirm.html.erb] → [完了画面]
     ↓               ↓                    ↓
  confirm action   create action      show action
     ↓               ↓                    ↓
  セッション保存    DB保存・メール送信    成功メッセージ
```

### ルーティング

```ruby
resources :inquiries do
  collection do
    post :confirm    # 確認画面への遷移
  end
end
```

## コンポーネント設計

### 1. InquiriesController の拡張

#### 新規アクション

- `confirm`: フォームデータをバリデーションし、確認画面を表示
- `create`: 確認画面からの送信処理（既存を修正）

#### セッション管理

- `session[:inquiry_params]`: 確認画面用の一時データ保存
- 送信完了後にセッションクリア

### 2. ビューファイル

#### new.html.erb の修正

- 送信ボタンを「確認する」に変更
- フォームのaction先を`confirm_inquiries_path`に変更

#### confirm.html.erb の新規作成

- 入力内容の表形式表示
- 「戻る」「送信する」ボタンの配置
- 隠しフィールドでデータ保持

### 3. バリデーション戦略

- 確認画面遷移時: フルバリデーション実行
- 送信処理時: 再バリデーション実行
- エラー時の適切な画面遷移

## データモデル

### セッションデータ構造

```ruby
session[:inquiry_params] = {
  name: "お名前",
  email: "メールアドレス", 
  furigana: "フリガナ",
  inquiry_type: "dependency|company_info|other",
  phone: "電話番号",
  address: "住所",
  content: "お問い合わせ内容"
}
```

### Inquiryモデル

既存のモデルをそのまま使用。追加の変更は不要。

## インターフェース設計

### 確認画面のレイアウト

```
┌─────────────────────────────────┐
│ お問い合わせ内容確認             │
├─────────────────────────────────┤
│ ┌─────────┬─────────────────┐   │
│ │ お名前   │ 山田太郎         │   │
│ ├─────────┼─────────────────┤   │
│ │ フリガナ │ ヤマダタロウ     │   │
│ └─────────┴─────────────────┘   │
│                                 │
│ [戻る]              [送信する]   │
└─────────────────────────────────┘
```

## エラーハンドリング

### バリデーションエラー

- 確認画面遷移時: new.html.erb にエラー表示
- 送信処理時: confirm.html.erb にエラー表示

### セッションエラー

- セッション無効時: new.html.erb にリダイレクト
- 適切なエラーメッセージ表示

## テスト戦略

### 単体テスト

- InquiriesController の各アクションテスト
- バリデーション処理のテスト
- セッション管理のテスト

### 統合テスト

- フォーム → 確認画面 → 送信完了の一連フロー
- エラー時の画面遷移
- メール送信の確認

## セキュリティ考慮事項

- セッションデータの適切な管理
- CSRF トークンの検証
- XSS 対策（入力値のエスケープ）
- セッションハイジャック対策

## パフォーマンス考慮事項

- セッションサイズの最適化
- 不要なセッションデータの定期クリーンアップ
- データベースアクセスの最適化